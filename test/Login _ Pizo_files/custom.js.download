var land = {
    init: function () {
        land.scroll();
    },
    scroll: function () {
        window.onscroll = function () {
            land.scrollFunction();

            var lastScrollLeft = 0;
            var documentScrollLeft = $(document).scrollLeft();
            if (lastScrollLeft != documentScrollLeft) {
                lastScrollLeft = documentScrollLeft;
                $('.thead-fixed').css('left', parseFloat('-' + (lastScrollLeft - 35)));
                $('.table-fixed').removeAttr('style');
            }
        };
    },

    scrollFunction: function () {
        if (document.body.scrollTop > 140 || document.documentElement.scrollTop > 140) {
            $('.thead-fixed').css({
                'position': 'fixed',
                'top': 0,
                'left': '35px',
                'z-index': 999
            });
            $('.table-fixed').css({
                'margin-top': '150px',
            });

        } else {
            $('.thead-fixed,.table-fixed').removeAttr('style');
        }
    },
    scrollLeft: function () {

        $('.table-fixed').on('scroll', function () {
            var left = $('.tbl-full-width').offset().left;
            $('.thead-fixed').css({
                'position': 'fixed',
                'top': 0,
                'left': left,
                'z-index': 999
            });
        });
    },
}

$(document).ready(function () {
    land.init();
})

var _token;

function get_csrf_token() {
    _token = $('meta[name="csrf-token"]').attr('content');
    return _token;
}

function set_csrf_token(token) {
    _token = token;
    $('meta[name="csrf-token"]').attr('content', token);
}

//check all button
$(document).on('click', '.check-all', function (event) {
    $('.check-all-child').prop('checked', this.checked);
    $('.check-all').prop('checked', this.checked);
});

var val = [];

function getChecked(number, name) {
    if (number == undefined)
        var number = 1;
    if (name == undefined)
        var name = ' dự án';

    val = [];
    $('.check-all-child:checked').each(function () {
        val.push($(this).val());
    });

    if (val.length < number) {
        alert('Vui lòng chọn ít nhất ' + number + name + '!');
        return false;
    }
    return true;
}

$('.image_select').on('dragenter', function () {
    $(this).parent().find('div').addClass('dragover');
});

$('.image_select').on('dragleave', function () {
    $(this).parent().find('div').removeClass('dragover');
});

$(document).on('click', '.status-sold', function () {
    $(document).find('.status-sold').removeClass('active');
    $(this).addClass('active');
    $(document).find('#product_status').val($(this).attr('land-status'));
});

$(document).on('click', '.status-sold-reset', function () {
    $(document).find('.status-sold').removeClass('active');
    $(document).find('#product_status').val('');
    $(document).find('#note-land-content-2').val('');
});

// $(document).on('click', '.btn-edit-product', function () {
//     $('#info-product').addClass('hide');
//     $('#edit-product').removeClass('hide');
// });

$(document).on('click', '.box-edit .current', function () {
    $(this).addClass('hide');
    $(this).parent().find('.form-edit').removeClass('hide');
});

$(document).on('change', '#form-update select[name="home_structure"]', function () {
    if ($(document).find('#form-update select[name="home_structure"]').val() == 3) {
        $(document).find('#form-update .home_stucture_detail').removeClass('hide');
    } else {
        $(document).find('#form-update .home_stucture_detail').addClass('hide');
    }

    if ($(document).find('#form-update select[name="home_structure"]').val() == 2 || $(document).find('#form-update select[name="home_structure"]').val() == 3)
        $(document).find('#form-update .home_interior').removeClass('hide');
    else
        $(document).find('#form-update .home_interior').addClass('hide');
})

$(document).on('click', '.box-edit .save', function () {

    var form = $(this).parent().parent().parent().parent().find('.form-edit');
    var current = $(this).parent().parent().parent().parent().find('.current');
    form.addClass('hide');
    current.removeClass('hide');

    var block = $(this).data('block');

    if (block == 'address') {
        var province_text = form.find('.select_province').find('option:selected').text();
        var province_id = form.find('.select_province').val();

        var district_text = form.find('.select_district').find('option:selected').text();
        var district_id = form.find('.select_district').val();

        var ward_text = form.find('.select_ward').find('option:selected').text();
        var ward_id = form.find('.select_ward').val();

        var street_text = form.find('select[name="street_id"]').find('option:selected').text();
        var street_id = form.find('select[name="street_id"]').val();

        var home_number = form.find('input[name="home_number"]').val();
        var home_number_note = form.find('input[name="home_number_note"]').val();

        var old_street_text = form.find('select[name="old_street_id"]').find('option:selected').text();
        var old_street_street_id = form.find('select[name="old_street_id"]').val();

        var new_address = '';

        if (home_number)
            new_address = home_number;

        if (street_id != '')
            new_address = new_address ? new_address + ' ' + street_text : street_text;

        if (ward_id != '')
            new_address = new_address ? new_address + ', ' + ward_text : ward_text;

        if (district_id != '')
            new_address = new_address ? new_address + ', ' + district_text : district_text;

        if (province_id != '')
            new_address = new_address ? new_address + ', ' + province_text : province_text;

        if (new_address != '')
            current.find('.new_address').html(new_address).removeClass('hide');
        else
            current.find('.new_address').addClass('hide');

        if (home_number_note || old_street_street_id != '')
            current.find('.new_home_number_note').html(home_number_note + ' ' + old_street_text).removeClass('hide');
        else
            current.find('.new_home_number_note').addClass('hide');

    } else if (block == 'status') {
        var status_text = form.find('select[name="status"]').find('option:selected').text();
        var status_id = form.find('select[name="status"]').val();

        var price = form.find('input[name="price"]').val();

        var price_type_text = form.find('select[name="price_type"]').find('option:selected').text();
        var price_type_id = form.find('select[name="price_type"]').val();

        if (status_id != '')
            current.find('.new_status').html(status_text).removeClass('hide');
        else
            current.find('.new_status').addClass('hide');

        var new_price = '';

        if (price)
            new_price = price;

        if (price_type_id != '')
            new_price = new_price ? new_price + ' ' + price_type_text : price_type_text;

        if (new_price != '')
            current.find('.new_price').html(' ' + new_price).removeClass('hide');
        else
            current.find('.new_price').addClass('hide');

    } else if (block == 'dimension') {
        var horizontal = form.find('input[name="horizontal"]').val();
        var vertical = form.find('input[name="vertical"]').val();
        var area = form.find('input[name="area"]').val();
        var land_area = form.find('input[name="land_area"]').val();
        var floor_area = form.find('input[name="floor_area"]').val();

        var home_structure_text = form.find('select[name="home_structure"]').find('option:selected').text();
        var home_structure_id = form.find('select[name="home_structure"]').val();

        if (horizontal > 0)
            current.find('.new_horizontal').html(horizontal).removeClass('hide');
        else
            current.find('.new_horizontal').addClass('hide');

        if (vertical > 0)
            current.find('.new_vertical').html(vertical).removeClass('hide');
        else
            current.find('.new_vertical').addClass('hide');

        if (area > 0)
            current.find('.new_area').html(area).removeClass('hide');
        else
            current.find('.new_area').addClass('hide');

        if (land_area > 0)
            current.find('.new_land_area').html(land_area).removeClass('hide');
        else
            current.find('.new_land_area').addClass('hide');

        if (floor_area > 0)
            current.find('.new_floor_area').html(floor_area).removeClass('hide');
        else
            current.find('.new_floor_area').addClass('hide');

        if (home_structure_id != '') {
            if (home_structure_id == 3) {
                home_structure_text = '';

                var basement_number = form.find('input[name="basement_number"]').val();
                var floor_number = form.find('input[name="floor_number"]').val();
                var mezzanine_number = (form.find('input[name="mezzanine_number"]').prop('checked') === true);
                var terrace = (form.find('input[name="terrace"]').prop('checked') === true);

                if (basement_number > 0)
                    home_structure_text += parseInt(basement_number) + ' hầm';

                if (floor_number > 0)
                    home_structure_text += home_structure_text ? ' + ' + parseInt(floor_number) + ' tầng' : parseInt(floor_number) + ' tầng';

                if (mezzanine_number)
                    home_structure_text += home_structure_text ? ' +  lửng' : 'lửng';

                if (terrace)
                    home_structure_text += home_structure_text ? ' +  sân thượng' : ' sân thượng';
            }

            current.find('.new_home_structure_text').html(home_structure_text).removeClass('hide');
        } else {
            current.find('.new_home_structure_text').addClass('hide');
        }

        var purpose_text = '';

        $.each(form.find('.select_purpose').find('option:selected'), function (i, v) {
            purpose_text += purpose_text ? ', ' + $(v).text() : $(v).text();
        })

        var purpose_ids = form.find('.select_purpose').val();

        // console.log(purpose_text);
        // console.log(purpose_ids);

        if (purpose_text != '')
            current.find('.new_purpose').html(purpose_text).removeClass('hide');
        else
            current.find('.new_purpose').addClass('hide');

    } else if (block == 'description') {
        var description = form.find('textarea[name="description"]').val();
        if (description != '')
            current.find('.new_description').html(description).removeClass('hide');
        else
            current.find('.new_description').addClass('hide');

    } else if (block == 'dac-diem') {

        var home_facade_text = form.find('select[name="home_facade"]').find('option:selected').text();
        var home_facade_id = form.find('select[name="home_facade"]').val();

        if (home_facade_id != '')
            current.find('.new_home_facade_text').html(home_facade_text).removeClass('hide');
        else
            current.find('.new_home_facade_text').addClass('hide');

        var road_width = form.find('input[name="road_width"]').val();

        if (road_width > 0)
            current.find('.new_road_width').html(road_width).removeClass('hide');
        else
            current.find('.new_road_width').addClass('hide');

        var home_direction_name = form.find('select[name="home_direction"]').find('option:selected').text();
        var home_direction_id = form.find('select[name="home_direction"]').val();

        if (home_direction_id != '')
            current.find('.new_home_direction_name').html(home_direction_name).removeClass('hide');
        else
            current.find('.new_home_direction_name').addClass('hide');

        var legal_status_name = form.find('select[name="legal_status"]').find('option:selected').text();
        var legal_status_id = form.find('select[name="legal_status"]').val();

        if (legal_status_id != '')
            current.find('.new_legal_status_name').html(legal_status_name).removeClass('hide');
        else
            current.find('.new_legal_status_name').addClass('hide');

        var monthly_price = form.find('input[name="monthly_price"]').val();

        var monthly_price_unit_text = form.find('select[name="monthly_price_unit"]').find('option:selected').text();
        var monthly_price_unit_id = form.find('select[name="monthly_price_unit"]').val();

        var new_monthly_price = '';

        if (monthly_price)
            new_monthly_price = monthly_price;

        if (monthly_price_unit_id != '')
            new_monthly_price = new_monthly_price ? new_monthly_price + ' ' + monthly_price_unit_text : monthly_price_unit_text;

        if (new_monthly_price != '')
            current.find('.new_monthly_price').html(' ' + new_monthly_price).removeClass('hide');
        else
            current.find('.new_monthly_price').addClass('hide');

    } else if (block == 'interior') {
        var bedroom_number = form.find('input[name="bedroom_number"]').val();
        var room_number = form.find('input[name="room_number"]').val();
        var bathroom_number = form.find('input[name="bathroom_number"]').val();
        var kitchen_number = form.find('input[name="kitchen_number"]').val();
        var balcony_number = (form.find('input[name="balcony_number"]').prop('checked') === true);
        var elevator = (form.find('input[name="elevator"]').prop('checked') === true);

        if (bedroom_number != '')
            current.find('.new_bedroom_number').html(bedroom_number).removeClass('hide');
        else
            current.find('.new_bedroom_number').addClass('hide');

        if (room_number != '')
            current.find('.new_room_number').html(room_number).removeClass('hide');
        else
            current.find('.new_room_number').addClass('hide');

        if (bathroom_number != '')
            current.find('.new_bathroom_number').html(bathroom_number).removeClass('hide');
        else
            current.find('.new_bathroom_number').addClass('hide');

        if (kitchen_number != '')
            current.find('.new_kitchen_number').html(kitchen_number).removeClass('hide');
        else
            current.find('.new_kitchen_number').addClass('hide');

        if (balcony_number)
            current.find('.new_balcony_number').html('Có').removeClass('hide');
        else
            current.find('.new_balcony_number').addClass('hide');

        if (elevator)
            current.find('.new_elevator').html('Có').removeClass('hide');
        else
            current.find('.new_elevator').addClass('hide');

    } else if (block == 'convenience') {
        var convenience_text = '';

        $.each(form.find('.select_convenience').find('option:selected'), function (i, v) {
            convenience_text += convenience_text ? ', ' + $(v).text() : $(v).text();
        })

        var convenience_ids = form.find('.select_convenience').val();

        if (convenience_ids != '')
            current.find('.new_convenience').html(convenience_text).removeClass('hide');
        else
            current.find('.new_convenience').addClass('hide');
    } else if (block == 'exterior') {
        var exterior_text = '';

        $.each(form.find('.select_exterior').find('option:selected'), function (i, v) {
            exterior_text += exterior_text ? ', ' + $(v).text() : $(v).text();
        })

        var exterior_ids = form.find('.select_exterior').val();

        if (exterior_ids != '')
            current.find('.new_exterior').html(exterior_text).removeClass('hide');
        else
            current.find('.new_exterior').addClass('hide');

    } else if (block == 'contact') {

        $.each(form.find('.input_contact_name'), function (i, v) {

            var contact_id = $(v).data('id');
            var contact_name = $(v).val();

            if (contact_name != '') {
                current.find('.new_contact_name_' + contact_id).html(contact_name).removeClass('hide');
            } else {
                current.find('.new_contact_name_' + contact_id).addClass('hide');
            }
        });

        $.each(form.find('.select_contact_type_name'), function (i, v) {
            var contact_id = $(v).data('id');
            var contact_type_name = $(v).find('option:selected').text();

            current.find('.new_contact_type_name_' + contact_id).html(contact_type_name).removeClass('hide');
        });

        $.each(form.find('.select_contact_status_name'), function (i, v) {
            var contact_id = $(v).data('id');
            var contact_status_name = $(v).find('option:selected').text();

            current.find('.new_contact_status_name_' + contact_id).html(contact_status_name).removeClass('hide');
        });

        var input_new_contact_names = [];
        $.each(form.find('.input_new_contact_name'), function (i, v) {
            input_new_contact_names.push($(v).val());
        })

        var input_new_contact_phones = [];
        $.each(form.find('.input_new_contact_phone'), function (i, v) {
            input_new_contact_phones.push($(v).val());
        })

        var input_new_contact_types = [];
        $.each(form.find('.input_new_contact_type'), function (i, v) {
            input_new_contact_types.push($(v).find('option:selected').text());
        })

        var input_new_contact_status = [];
        $.each(form.find('.input_new_contact_status'), function (i, v) {
            input_new_contact_status.push($(v).find('option:selected').text());
        })

        var new_contact_html = '';

        $.each(input_new_contact_names, function (i, v) {
            if (input_new_contact_names[i] != '' && input_new_contact_phones[i] != '' && input_new_contact_types[i] != '') {
                new_contact_html += "<div class='row'>";
                new_contact_html += "<p class='col-md-3 mb-0'>" + input_new_contact_names[i] + "</p>";
                new_contact_html += "<p class='col-md-3 mb-0'>" + input_new_contact_phones[i] + "</p>";
                new_contact_html += "<p class='col-md-3 mb-0'>" + input_new_contact_types[i] + "</p>";
                new_contact_html += "<p class='col-md-3 mb-0'>" + input_new_contact_status[i] + "</p>";
                new_contact_html += "</div>";
            }
        })

        current.find('.new_contact_container').html(new_contact_html);
    }
});

$(document).on('click', '.submit_form_update', function () {
    //console.log($('#form-update').serializeArray())
    if (confirm('Gửi yêu cầu chỉnh sửa?') !== true)
        return false;

    $.ajax({
        url: $('#form-update').attr('action'),
        type: 'post',
        data: $('#form-update').serialize(),
        success: function (data) {
            if (data.status) {
                alert('Gửi yêu cầu thành công!');
            } else {
                alert(data.error);
            }
            //window.location.reload();
            $('.btn-detail-product').trigger('click');
        }
    });
})

$(document).on('click', '.expanse_tr', function () {
    $(this).nextUntil('tr.expanse_tr').slideToggle(100);
});
